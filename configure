#!/bin/bash

# (C) 2007, Robert Bradshaw, William Hart, William Stein, Michael Abshoff
# (C) 2011, William Hart

MPIR_DIR="/usr/local"
MPFR_DIR="/usr/local"
PREFIX="/usr/local"

usage()
{
   echo "Usage: ./configure <options> <args>"
   echo "   where <options> may be"
   echo "     -h display usage information"
   echo "   where <args> may be:"
   echo "     --with-mpir=<path> Specify location of MPIR"
   echo "     --with-mpfr=<path> Specify location of MPFR"
   echo "     --prefix=<path>    Specify path to installation location"
}

until [ -z "$1" ]; do
   case $1 in
      "-h") usage
         exit 0
         ;;
      "--with-mpir="*)
         MPIR_DIR=${1:12}
         ;;
      "--with-mpfr="*)
         MPFR_DIR=${1:12}
         ;;
      "--prefix="*)
         PREFIX=${1:9}
	 ;;
      *) usage
         exit 1
         ;; 
   esac
   shift
done

if [ -d "${MPIR_DIR}/lib" ]; then
   MPIR_LIB_DIR="${MPIR_DIR}/lib"
   MPIR_INCLUDE_DIR="${MPIR_DIR}/include"
elif [ -d "${MPIR_DIR}/.libs" ]; then
   MPIR_LIB_DIR="${MPIR_DIR}/.libs"
   MPIR_INCLUDE_DIR="${MPIR_DIR}"
else
   echo "Invalid MPIR directory"
   exit 1
fi

if [ -d "${MPFR_DIR}/lib" ]; then
   MPFR_LIB_DIR="${MPFR_DIR}/lib"
   MPFR_INCLUDE_DIR="${MPFR_DIR}/include"
elif [ -d "${MPFR_DIR}/.libs" ]; then
   MPFR_LIB_DIR="${MPFR_DIR}/.libs"
   MPFR_INCLUDE_DIR="${MPFR_DIR}"
else
   echo "Invalid MPFR directory"
   exit 1
fi

if [ -d "${PREFIX}/lib" ]; then
   FLINT_LIB_DIR="${PREFIX}/lib"
   FLINT_INCLUDE_DIR="${PREFIX}/include"
else
   FLINT_LIB_DIR="${PREFIX}"
   FLINT_INCLUDE_DIR="${PREFIX}"
fi

if [ "`uname`" = "Linux" -a "`uname -m`" = "x86_64" ]; then
   FLINT_TUNE="-funroll-loops "
elif [ "`uname`" = "Darwin" -a "`uname -m`" = "Power Macintosh" ]; then
   FLINT_TUNE=" -funroll-loops "
elif [ "`uname -p`" = "powerpc" ]; then
   FLINT_TUNE="-m64 -mcpu=970 -mtune=970 -mpowerpc64 -falign-loops=16 -falign-functions=16 -falign-labels=16 -falign-jumps=16"
elif [ "`uname -m`" = "ia64" ]; then
   # -funroll-loops crashes the build on itanium under GCC-4.2.1, as reported by
   # Kate Minola.
   FLINT_TUNE=" "
else
   FLINT_TUNE="-funroll-loops "
fi

if [ "`uname`" = "Darwin" ]; then
   FLINT_LIB="libflint.dylib"
else
   FLINT_LIB="libflint.so"
fi

echo "# This file is autogenerated by ./configure -- do not edit!" > Makefile.tmp
echo "" >> Makefile.tmp
echo "FLINT_MPIR_LIB_DIR=$MPIR_LIB_DIR" >> Makefile.tmp
echo "FLINT_MPIR_INCLUDE_DIR=$MPIR_INCLUDE_DIR" >> Makefile.tmp
echo "FLINT_MPFR_LIB_DIR=$MPFR_LIB_DIR" >> Makefile.tmp
echo "FLINT_MPFR_INCLUDE_DIR=$MPFR_INCLUDE_DIR" >> Makefile.tmp
echo "FLINT_LIB_DIR=${FLINT_LIB_DIR}" >> Makefile.tmp
echo "FLINT_INCLUDE_DIR=${FLINT_INCLUDE_DIR}" >> Makefile.tmp
echo "" >> Makefile.tmp
echo "FLINT_TUNE=$FLINT_TUNE" >> Makefile.tmp
echo "FLINT_LIB=$FLINT_LIB" >> Makefile.tmp
echo "" >> Makefile.tmp

cat Makefile.tmp Makefile.in > Makefile
rm Makefile.tmp

