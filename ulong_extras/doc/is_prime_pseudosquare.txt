/*============================================================================

    Copyright (C) 2009 William Hart

    This file is part of FLINT.

    FLINT is free software; you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation; either version 2 of the License, or
    (at your option) any later version.

    FLINT is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with FLINT; if not, write to the Free Software
    Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301 USA

===============================================================================*/

int n_is_prime_pseudosquare(mp_limb_t n)

   Tests if n is a prime according to Theorem 2.7 of "Some
   results on pseudosquares" by Lukes, Patterson and Williams,
   Math. Comp. vol 65, No. 213. pp 361-372. See
   http://www.ams.org/mcom/1996-65-213/S0025-5718-96-00678-3/S0025-5718-96-00678-3.pdf

   We first factor N using trial division up to some limit B.
   In fact we use FLINT_PSEUDOSQUARES_CUTOFF primes in the trial
   factoring.

   Next we compute N/B and find the next pseudosquare L_p above
   this value, using a static table as per:
   http://research.att.com/~njas/sequences/b002189.txt
 
   As noted in the text, if p is prime then step 3 will pass. This
   test rejects many composites, and so by this time we suspect
   that p is prime. If N is 3 or 7 mod 8, we are done, and N is 
   prime.

   We now run a probable prime test, for which no known 
   counterexamples are known, to reject any composites. We then 
   proceed to prove N prime by executing step 4. In the case that
   N is 1 mod 8, if step 4 fails, we extend the number of primes
   p_i at step 3 and hope to find one which passes step 4. We take
   the test one past the largest p for which we have pseudosquares
   L_p tabulated, as this already corresponds to the next L_p which 
   is bigger than 2^64 and hence larger than any prime we might be
   testing.

   As explained in the text, condition 4 cannot fail if N is prime.

   The possibility exists that the probable prime test declares a
   composite prime. However in that case an error is printed, as
   that would be of independent interest.